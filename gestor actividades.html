<!DOCTYPE html>
<html lang="es">

<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Actividades - Villa Victoria</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* CONSTANTES DE COLOR ajustadas al color del encabezado (Dark Gray) */
        :root {
            --stm-main-color: #2D3748;
            /* Color unificado principal (Gris Oscuro) */
            --stm-teal: #34B3C5;
            /* Turquesa (Crear) - Se mantiene para diferenciar la acción de creación */
            --stm-red: #dc3545;
            /* Rojo (Eliminar) */
            --stm-gray: #f8f9fa;
            /* Fondo de página */
            --stm-light-main: #4A5568;
            /* Gris más claro para hover */
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--stm-gray);
            padding-top: 20px;
        }

        .header-section {
            background-color: white;
            /* Fondo blanco */
            color: #2D3748;
            /* Letras en gris oscuro/negro */
            padding: 30px 0;
            /* Un poco más de aire */
            border-radius: 8px 8px 0 0;
            border-bottom: 1px solid #dee2e6;
            /* Una línea sutil para separar */
        }

        .header-logo {
            max-width: 180px;
            /* Logo más grande */
            height: auto;
            border-radius: 0;
            /* Sin círculo */
            border: none;
            /* Sin borde blanco */
            margin-bottom: 15px;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        /* Color del encabezado de la tarjeta/tabla */
        .card-header-custom {
            background-color: var(--stm-main-color);
            color: white;
            padding: 10px 15px;
            font-weight: 700;
        }

        /* Botón Crear (se mantiene el turquesa para diferenciar la acción principal) */
        .btn-custom-teal {
            background-color: var(--stm-teal);
            border-color: var(--stm-teal);
            color: white;
            transition: all 0.2s;
        }

        .btn-custom-teal:hover {
            background-color: #2CAAB7;
            border-color: #2CAAB7;
            color: white;
            transform: translateY(-1px);
        }

        /* Botón Guardar / Botones Principales (antes púrpura, ahora gris oscuro principal) */
        .btn-custom-purple,
        .btn-stm-primary {
            background-color: var(--stm-main-color) !important;
            border-color: var(--stm-main-color) !important;
            color: white !important;
            transition: all 0.2s;
        }

        .btn-custom-purple:hover,
        .btn-stm-primary:hover {
            background-color: var(--stm-light-main) !important;
            border-color: var(--stm-light-main) !important;
            color: white !important;
            transform: translateY(-1px);
        }

        /* Pestañas activas y hover */
        .nav-link.active,
        .nav-link:hover {
            color: var(--stm-main-color) !important;
        }

        .nav-link.active {
            border-bottom: 3px solid var(--stm-main-color) !important;
            border-top-color: transparent !important;
            border-left-color: transparent !important;
            border-right-color: transparent !important;
            background-color: white;
        }

        .table-responsive {
            margin-top: 15px;
        }

        .table thead th {
            background-color: #e9ecef;
            color: var(--stm-main-color);
            border-bottom: 2px solid #dee2e6;
        }

        .table tbody tr:hover {
            background-color: #f1f1f1;
        }

        .action-btns .btn {
            margin: 2px;
            padding: 5px 10px;
            font-size: 0.85rem;
        }

        /* Iconos de editar en la tabla (usando el color principal) */
        .btn-primary {
            background-color: var(--stm-main-color) !important;
            border-color: var(--stm-main-color) !important;
        }

        .btn-primary:hover {
            background-color: var(--stm-light-main) !important;
            border-color: var(--stm-light-main) !important;
        }

        /* Modal Header (Color unificado) */
        .modal-header {
            background-color: var(--stm-main-color) !important;
            color: white !important;
        }

        /* Color de carga (Loading) */
        .loading-text {
            margin-left: 10px;
            font-weight: bold;
            color: var(--stm-main-color);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1050;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .loading-overlay.visible {
            visibility: visible;
            opacity: 1;
        }

        .feedback {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
            min-width: 250px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 15px;
            display: none;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(-20px);
        }

        .feedback.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .feedback.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .feedback.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Estilos específicos para el modal de formulario */
        .form-label {
            font-weight: 500;
        }

        /* Estilos para el modal de actividades de hoy */
        #actividadHoyModal .modal-header {
            background-color: #ffc107 !important;
            /* Amarillo de Bootstrap 'warning' (Se mantiene para diferenciación de alerta) */
            color: #212529 !important;
            /* Texto oscuro */
        }

        /* Estilos para las pestañas con iconos */
        .nav-link i {
            margin-right: 5px;
        }
    </style>
</head>

<body>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="d-flex align-items-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <span class="loading-text" id="loadingText">Cargando datos...</span>
        </div>
    </div>

    <div class="feedback" id="feedbackMessage"></div>

    <div class="container main-container">
        <div class="header-section text-center p-3 mb-4 rounded-top-lg">
            <img src="logo AAVV.png" alt="Logo Villa Victoria" class="header-logo">

            <h1 style="color: black; font-weight: 700;">Gestor de información</h1>
            <p class="lead" style="color: #4A5568;">Asociación Amigos Villa Victoria</p>
        </div>

        <div class="d-flex justify-content-between align-items-center p-3">
            <h2 class="h4 mb-0">Listado de Actividades</h2>
            <div class="d-flex gap-2">
                <button class="btn btn-custom-teal" onclick="showModal('Muestra')">
                    <i class="fas fa-plus-circle"></i> Nueva Muestra
                </button>
                <button class="btn btn-custom-teal" onclick="showModal('Programacion')">
                    <i class="fas fa-plus-circle"></i> Nueva Programación
                </button>
                <button class="btn btn-custom-teal" onclick="showModal('socios')">
                    <i class="fas fa-plus-circle"></i> Nuevo Socio
                </button>

            </div>
        </div>

        <ul class="nav nav-tabs nav-justified" id="activityTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="muestras-tab" data-bs-toggle="tab" data-bs-target="#muestras"
                    type="button" role="tab" aria-controls="muestras" aria-selected="true"
                    onclick="setActiveTab('Muestra')">
                    <i class="fas fa-camera-retro"></i> Muestras
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="programaciones-tab" data-bs-toggle="tab" data-bs-target="#programaciones"
                    type="button" role="tab" aria-controls="programaciones" aria-selected="false"
                    onclick="setActiveTab('Programacion')">
                    <i class="fas fa-calendar-alt"></i> Programación
                </button>
            </li>

            <button class="nav-link" id="socios-tab" data-bs-toggle="tab" data-bs-target="#socios" type="button"
                role="tab" aria-controls="socios" aria-selected="false" onclick="setActiveTab('socios')">
                <i class="fas fa-users"></i> Socios
            </button>
        </ul>

        <div class="tab-content p-3 border border-top-0 rounded-bottom-lg">
            <div class="tab-pane fade show active" id="muestras" role="tabpanel" aria-labelledby="muestras-tab">
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle" id="muestrasTable">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 0; display:none;">ID</th>
                                <th scope="col" style="width: 25%;">Nombre</th>
                                <th scope="col" style="width: 25%;">Período</th>
                                <th scope="col" style="width: 30%;">Detalle</th>
                                <th scope="col" style="width: 10%;">Activo</th>
                                <th scope="col" style="width: 10%;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="programaciones" role="tabpanel" aria-labelledby="programaciones-tab">
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle" id="programacionesTable">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 0; display:none;">ID</th>
                                <th scope="col" style="width: 10%;">Fecha</th>
                                <th scope="col" style="width: 7%;">Hora</th>
                                <th scope="col" style="width: 20%;">Título</th>
                                <th scope="col" style="width: 25%;">Detalle</th>
                                <th scope="col" style="width: 15%;">Costo</th>
                                <th scope="col" style="width: 8%;">Activo</th>
                                <th scope="col" style="width: 15%;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="socios" role="tabpanel" aria-labelledby="socios-tab">
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle" id="sociosTable">
                        <thead>
                            <tr>
                                <th scope="col" style="display:none;">ID</th>
                                <th scope="col">Apellido y Nombre</th>
                                <th scope="col">DNI</th>
                                <th scope="col">Email</th>
                                <th scope="col">Cumpleaños</th>
                                <th scope="col">Celular</th>
                                <th scope="col">Residencia</th>
                                <th scope="col">Activo</th>
                                <th scope="col">Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="actividadModal" tabindex="-1" aria-labelledby="actividadModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="actividadModalLabel">Crear Actividad</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <form id="actividadForm" class="needs-validation" novalidate>
                    <div class="modal-body">
                        <input type="hidden" id="actividadTipo" name="actividadTipo" value="">
                        <input type="hidden" id="actividadId" name="actividadId" value="">

                        <div id="formContent">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Estado de Actividad</label>
                            <div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="activo" id="activoSI"
                                        value="true" required>
                                    <label class="form-check-label" for="activoSI">Activo (SI)</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="activo" id="activoNO"
                                        value="false" required>
                                    <label class="form-check-label" for="activoNO">Inactivo (NO)</label>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="button" class="btn btn-custom-purple" id="saveActividadBtn">
                            <i class="fas fa-save"></i> Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteConfirmModalLabel"><i class="fas fa-trash-alt"></i> Confirmar
                        Eliminación</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Estás seguro de que deseas eliminar esta actividad: <strong id="deleteActividadInfo"></strong>?
                    </p>
                    <p class="text-danger">¡Esta acción no se puede deshacer!</p>
                    <input type="hidden" id="deleteId" value="">
                    <input type="hidden" id="deleteTipo" value="">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger"
                        onclick="deleteActividad(document.getElementById('deleteId').value, document.getElementById('deleteTipo').value)">Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="actividadHoyModal" tabindex="-1" aria-labelledby="actividadHoyModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="actividadHoyModalLabel"><i class="fas fa-bell me-2"></i> ¡ATENCIÓN!
                        Actividades para Hoy</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <p class="lead">Se encontraron actividades de Programación programadas para el día de hoy, <strong
                            id="todayDateDisplay"></strong>:</p>
                    <ul id="actividadesHoyList" class="list-group list-group-flush">
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-stm-primary" data-bs-dismiss="modal"
                        onclick="document.getElementById('programaciones-tab').click()">
                        Ver Programaciones
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.8/jquery.inputmask.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // URL DE TU WEB APP (DEBE SER REEMPLAZADA DESPUÉS DE CADA IMPLEMENTACIÓN NUEVA)
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyizWeh8aQU2SM5H5izjTb6LT8bWPbSbhvgQMhcETv9N3-eyJxVF4iFlqG5mroGu8YH1g/exec';
        // ID PLANILLA USUARIOS
        const USER_SPREADSHEET_ID = '1h3Q3aOYEsXqKC3xN4qj7K7SmkwpFQtZdd0POsZF77Dg';

        let actividadModal;
        let deleteConfirmModal;
        let actividadHoyModal; // Declaración de la variable para el modal de hoy
        let activeTab = 'Muestra';
        let actividadesCache = [];

        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar Modales
            actividadModal = new bootstrap.Modal(document.getElementById('actividadModal'));
            deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            // Inicialización correcta del Modal de Actividades para Hoy
            actividadHoyModal = new bootstrap.Modal(document.getElementById('actividadHoyModal'));

            // Asignar manejador de envío al botón del modal
            document.getElementById('saveActividadBtn').addEventListener('click', handleFormSubmission);

            // Inicializar la tabla activa y chequear actividades de hoy
            fetchActividades();
            checkTodayActivities(); // <--- ESTA FUNCIÓN SE LLAMA AL CARGAR
        });

        // =================================================================
        // UTILIDADES Y FORMATO
        // =================================================================

        /**
         * Convierte la fecha de formato ISO (YYYY-MM-DDTHH:MM:SS.sssZ) a DD/MM/AAAA (Tabla).
         * @param {string} dateString - Fecha en formato ISO o YYYY-MM-DD.
         * @returns {string} Fecha en formato 'DD/MM/AAAA' o la original si es inválida.
         */
        function formatToDisplayDate(dateString) {
            if (!dateString) return '';

            // Si ya viene en formato DD/MM (ej: "15/05"), lo devolvemos tal cual
            const regexDDMM = /^\d{1,2}\/\d{1,2}$/;
            if (regexDDMM.test(dateString.toString())) {
                return dateString;
            }

            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;

            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');

            // Si es para socios, quizás solo querés DD/MM, 
            // pero para Programación necesitás el año. 
            // Vamos a devolver DD/MM/YYYY por defecto y en el render lo manejamos.
            const year = date.getFullYear();
            return `${day}/${month}`;
        }

        /**
         * Ordena las actividades por fecha (si existe) o ID, de más reciente a más antigua.
         * (Más nuevo al más viejo).
         * @param {Array<Object>} actividades - Lista de actividades.
         * @param {string} tipo - 'Muestra' o 'Programacion'.
         * @returns {Array<Object>} Lista ordenada.
         */
function sortActividades(actividades, tipo) {
    if (!actividades || actividades.length === 0) return [];

    // Pasamos a minúscula para que no falle si viene como 'Socios' o 'socios'
    const tipoLower = tipo.toLowerCase();

    return actividades.sort((a, b) => {
        // --- ORDEN ALFABÉTICO PARA SOCIOS (Apellido y Nombre) ---
        if (tipoLower === 'socios') {
            const nombreA = (a.Apellido || "").toLowerCase();
            const nombreB = (b.Apellido || "").toLowerCase();
            return nombreA.localeCompare(nombreB);
        }

        // Ordenar por Programacion: fecha descendente (Más nueva primero)
        if (tipo === 'Programacion' && a.fecha && b.fecha) {
            if (a.fecha !== b.fecha) {
                return b.fecha.localeCompare(a.fecha);
            }
            if (a.hora && b.hora) {
                return b.hora.localeCompare(a.hora);
            }
            return 0;
        }

        // Ordenar por ID (Muestra o desempate): ID descendente
        if (a.id && b.id) {
            const idA = parseFloat(a.id) || 0;
            const idB = parseFloat(b.id) || 0;
            return idB - idA;
        }

        return 0;
    });
}

        // =================================================================
        // HTML DINÁMICO PARA EL FORMULARIO 
        // =================================================================

        const MUESTRA_FORM_HTML = `
            <div class="mb-3">
                <label for="nombreMuestra" class="form-label">Nombre de la Muestra</label>
                <input type="text" class="form-control" id="nombreMuestra" name="nombreMuestra" required>
                <div class="invalid-feedback">El nombre es obligatorio.</div>
            </div>

            <div class="mb-3">
                <label class="form-label">Período</label>
                <div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="tipoPeriodoMuestra" id="periodoPermanente" value="Permanente" checked onclick="togglePeriodoTexto(false)">
                        <label class="form-check-label" for="periodoPermanente">Permanente</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="tipoPeriodoMuestra" id="periodoTemporaria" value="Temporaria" onclick="togglePeriodoTexto(true)">
                        <label class="form-check-label" for="periodoTemporaria">Temporaria</label>
                    </div>
                </div>
            </div>

            <div class="mb-3" id="periodoMuestraTextoGroup" style="display:none;">
                <label for="periodoMuestraTexto" class="form-label">Descripción del Período Temporario (Ej: 10/2024 - 03/2025)</label>
                <input type="text" class="form-control" id="periodoMuestraTexto" name="periodoMuestraTexto">
                <div class="invalid-feedback">Debes ingresar una descripción si es Temporaria.</div>
            </div>

            <div class="mb-3">
                <label for="detalleMuestra" class="form-label">Detalle</label>
                <textarea class="form-control" id="detalleMuestra" name="detalleMuestra" required rows="3"></textarea>
            </div>
        `;

        const PROGRAMACION_FORM_HTML = `
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="fechaProgramacion" class="form-label">Fecha</label>
                    <input type="date" class="form-control" id="fechaProgramacion" name="fechaProgramacion" required>
                    <div class="invalid-feedback">La fecha es obligatoria.</div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="horaProgramacion" class="form-label">Hora</label>
                    <input type="text" class="form-control" id="horaProgramacion" name="horaProgramacion" required>
                </div>
            </div>
            <div class="mb-3">
                <label for="tituloProgramacion" class="form-label">Título de la Programación</label>
                <input type="text" class="form-control" id="tituloProgramacion" name="tituloProgramacion" required>
                <div class="invalid-feedback">El título es obligatorio.</div>
            </div>
            <div class="mb-3">
                <label for="detalleProgramacion" class="form-label">Detalle</label>
                <textarea class="form-control" id="detalleProgramacion" name="detalleProgramacion" rows="3" required></textarea>
            </div>

            <div class="mb-3">
                <label class="form-label">Costo</label>
                <div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="tipoCostoProgramacion" id="costoGratuito" value="Gratuito" checked onclick="toggleCostoMonto(false)">
                        <label class="form-check-label" for="costoGratuito">Libre y gratuita</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="tipoCostoProgramacion" id="costoFijo" value="Fijo" onclick="toggleCostoMonto(true)">
                        <label class="form-check-label" for="costoFijo">Costo Fijo</label>
                    </div>
                </div>
            </div>
            
            <div class="mb-3" id="costoMontoGroup" style="display:none;">
                <label for="montoCostoProgramacion" class="form-label">Monto (Ej: 5000)</label>
                <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="number" step="0.01" min="0" class="form-control" id="montoCostoProgramacion" name="montoCostoProgramacion" placeholder="0">
                </div>
                <div class="invalid-feedback">Debes ingresar el monto.</div>
            </div>
        `;
        const SOCIOS_FORM_HTML = `
    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">Apellido</label>
            <input type="text" class="form-control" name="Apellido" id="Apellido" required>
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" class="form-control" name="Nombre" id="Nombre" required>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">DNI</label>
            <input type="text" class="form-control" name="nro_dni" id="nro_dni" required>
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" name="email" id="email" required>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">F. Cumpleaños</label>
            <input type="text" class="form-control" name="f_cumple" id="f_cumple" placeholder="DD/MM">
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">Celular</label>
            <input type="text" class="form-control" name="tel_cel" id="tel_cel">
        </div>
    </div>
    <div class="mb-3">
        <label class="form-label">Lugar de Residencia</label>
        <input type="text" class="form-control" name="lugar_residencia" id="lugar_residencia">
    </div>
`;

        const USER_FORM_HTML = `
    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">Apellido</label>
            <input type="text" class="form-control" name="userApellido" id="Apellido" required>
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" class="form-control" name="userNombre" id="Nombre" required>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">Usuario (Login)</label>
            <input type="text" class="form-control" name="userUsuario" id="Usuario" required>
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">Password</label>
            <input type="password" class="form-control" name="userPassword" id="Password" required>
        </div>
    </div>
    <div class="mb-3">
        <label class="form-label">Permiso</label>
        <select class="form-select" name="userPermiso" id="Permiso" required>
            <option value="ADMIN">ADMIN</option>
            <option value="USER">USER</option>
        </select>
    </div>
`;
        function togglePeriodoTexto(show) {
            const group = document.getElementById('periodoMuestraTextoGroup');
            group.style.display = show ? 'block' : 'none';
            const input = document.getElementById('periodoMuestraTexto');
            if (show) {
                // Se mantiene el campo NO requerido, como fue solicitado.
            } else {
                input.removeAttribute('required');
                input.value = ''; // Limpiar si se oculta
            }
        }

        function toggleCostoMonto(show) {
            const group = document.getElementById('costoMontoGroup');
            group.style.display = show ? 'block' : 'none';
            const input = document.getElementById('montoCostoProgramacion');
            if (show) {
                input.setAttribute('required', 'required');
            } else {
                input.removeAttribute('required');
                input.value = ''; // Limpiar si se oculta
            }
        }

        // =================================================================
        // FUNCIÓN NUEVA: Aplica la máscara de hora (ELIMINADA)
        // =================================================================
        function applyProgramacionMasks() {
            // La función de máscara fue eliminada. El campo 'horaProgramacion' ahora se maneja como un input de texto simple.
            console.log("Máscara de hora deshabilitada.");
        }

        // =================================================================
        // MANEJO DE ESTADO Y UI
        // =================================================================

        function setActiveTab(tipo) {
            activeTab = tipo;
            fetchActividades();
        }

        function setLoadingState(isLoading, actionText = 'Cargando') {
            const overlay = document.getElementById('loadingOverlay');
            const text = document.getElementById('loadingText');
            if (isLoading) {
                text.textContent = `${actionText}...`;
                overlay.classList.add('visible');
            } else {
                overlay.classList.remove('visible');
            }
        }

        function showFeedback(message, isSuccess) {
            const feedback = document.getElementById('feedbackMessage');
            feedback.textContent = message;
            feedback.className = 'feedback show';
            feedback.classList.add(isSuccess ? 'success' : 'error');

            setTimeout(() => {
                feedback.classList.remove('show');
            }, 3000);
        }

        /**
  * Muestra el modal de edición/creación
  */
        function showModal(tipo, id = null) {
            const modalLabel = document.getElementById('actividadModalLabel');
            const formContent = document.getElementById('formContent');
            const form = document.getElementById('actividadForm');
            const estadoActividadGroup = document.querySelector('input[name="activo"]').closest('.mb-3');

            form.reset();
            form.classList.remove('was-validated');

            document.getElementById('actividadTipo').value = tipo;
            document.getElementById('actividadId').value = id || '';
            document.getElementById('saveActividadBtn').textContent = 'Guardar Cambios';

            estadoActividadGroup.style.display = 'block';

            if (tipo === 'Muestra') {
                formContent.innerHTML = MUESTRA_FORM_HTML;
                togglePeriodoTexto(false);
            } else if (tipo === 'socios') {
                formContent.innerHTML = SOCIOS_FORM_HTML;
            } else if (tipo === 'user') {
                formContent.innerHTML = USER_FORM_HTML;
                estadoActividadGroup.style.display = 'none';
                modalLabel.textContent = `Gestión de Usuario`;
                document.getElementById('saveActividadBtn').textContent = 'Guardar Usuario';

                if (id) {
                    // 1. Buscamos los datos del socio en la tabla actual para mostrar algo rápido
                    const filaSocio = Array.from(document.querySelectorAll('#sociosTable tbody tr')).find(tr =>
                        tr.cells[0].innerText === id.toString()
                    );

                    if (filaSocio) {
                        const nombreCompleto = filaSocio.cells[1].innerText.split(',');
                        const apellido = nombreCompleto[0].trim();
                        const nombre = nombreCompleto[1] ? nombreCompleto[1].trim() : '';

                        document.getElementById('Apellido').value = apellido;
                        document.getElementById('Nombre').value = nombre;

                        // Bloqueamos para que no editen el nombre acá (se cambia en Socios)
                        document.getElementById('Apellido').readOnly = true;
                        document.getElementById('Nombre').readOnly = true;
                        document.getElementById('Apellido').style.backgroundColor = "#e9ecef";
                        document.getElementById('Nombre').style.backgroundColor = "#e9ecef";
                    }

                    // 2. Ahora sí, vamos a la base 'user' a ver si ya tiene pass y permiso
                    setLoadingState(true, 'Verificando si ya tiene usuario...');
                    fetch(`${WEB_APP_URL}?action=READ_BY_ID&id=${id}&actividadTipo=user`)
                        .then(res => res.json())
                        .then(data => {
                            setLoadingState(false);
                            if (data.status === 'success' && data.actividad) {
                                // SI YA EXISTE: Cargamos lo que falta y cambiamos el título
                                modalLabel.textContent = `Actualizar Usuario: ${data.actividad.Usuario}`;
                                document.getElementById('Usuario').value = data.actividad.Usuario || '';
                                document.getElementById('Password').value = data.actividad.Password || '';
                                document.getElementById('Permiso').value = data.actividad.Permiso || 'USER';
                                document.getElementById('saveActividadBtn').textContent = 'Actualizar Usuario';
                            } else {
                                // SI ES NUEVO: Sugerimos un nombre de usuario
                                const apellidoLimpio = document.getElementById('Apellido').value.toLowerCase().replace(/\s+/g, '');
                                const inicialNombre = document.getElementById('Nombre').value.charAt(0).toLowerCase();
                                document.getElementById('Usuario').value = inicialNombre + apellidoLimpio;
                            }
                        })
                        .catch(err => {
                            setLoadingState(false);
                            console.error("Error buscando usuario:", err);
                        });
                }
            } else {
                formContent.innerHTML = PROGRAMACION_FORM_HTML;
                toggleCostoMonto(false);
            }

            if (id && tipo !== 'user') {
                modalLabel.textContent = `Editar ${tipo}`;
                document.getElementById('saveActividadBtn').textContent = 'Actualizar';
                readActividadById(id, tipo);
            }

            actividadModal.show();
        }

        // =================================================================
        // FUNCIONES CRUD DEL FRONTEND 
        // =================================================================

        /**
         * Llama a Apps Script para obtener todos los datos.
         */
        async function fetchActividades() {
            setLoadingState(true, 'Consultando datos');
            try {
                // El backend espera el nombre de la hoja en mayúsculas/minúsculas correctas
                const response = await fetch(`${WEB_APP_URL}?action=READ_ALL&actividadTipo=${activeTab}`);
                const data = await response.json();

                setLoadingState(false);

                if (data.status === 'success') {
                    actividadesCache = data.actividades;
                    // Ordenar antes de renderizar (Más reciente a más antiguo)
                    const actividadesOrdenadas = sortActividades(data.actividades, activeTab);
                    renderTable(actividadesOrdenadas, activeTab);
                } else {
                    showFeedback(`Error al cargar ${activeTab}: ${data.message}`, false);
                    renderTable([], activeTab);
                }
            } catch (error) {
                setLoadingState(false);
                showFeedback(`Error de conexión: ${error.message}`, false);
                renderTable([], activeTab);
            }
        }

        /**
         * Llama a Apps Script para leer una actividad por ID y rellenar el modal.
         */
        async function readActividadById(id, tipo) {
            setLoadingState(true, 'Cargando datos para editar');
            try {
                const response = await fetch(`${WEB_APP_URL}?action=READ_BY_ID&id=${id}&actividadTipo=${tipo}`);
                const data = await response.json();

                setLoadingState(false);
                if (data.status === 'success' && data.actividad) {
                    const actividad = data.actividad;
                    // Usamos .id para todos porque el servidor ya lo normalizó
                    document.getElementById('actividadId').value = actividad.id;
                    document.getElementById('actividadTipo').value = tipo;

                    // Estado Activo: En socios la columna es 'activo' (minúscula)
                    const valorActivoRaw = tipo === 'socios' ? actividad.activo : actividad.ACTIVO;
                    const activoValue = (valorActivoRaw && valorActivoRaw.toUpperCase() === 'SI') ? 'true' : 'false';
                    document.getElementById(activoValue === 'true' ? 'activoSI' : 'activoNO').checked = true;

                    // 2. Campos Específicos por Tipo
                    if (tipo === 'Muestra') {
                        document.getElementById('nombreMuestra').value = actividad.nombre;
                        document.getElementById('detalleMuestra').value = actividad.detalle;

                        if (actividad.periodo && actividad.periodo.toString().startsWith('Temporaria')) {
                            document.getElementById('periodoTemporaria').checked = true;
                            togglePeriodoTexto(true);
                            const periodoTexto = actividad.periodo.toString().replace('Temporaria:', '').trim();
                            document.getElementById('periodoMuestraTexto').value = periodoTexto;
                        } else {
                            document.getElementById('periodoPermanente').checked = true;
                            togglePeriodoTexto(false);
                        }

                    } else if (tipo === 'Programacion') {
                        if (actividad.fecha) {
                            const dateObj = new Date(actividad.fecha);
                            if (!isNaN(dateObj)) {
                                const yyyy = dateObj.getUTCFullYear();
                                const mm = String(dateObj.getUTCMonth() + 1).padStart(2, '0');
                                const dd = String(dateObj.getUTCDate()).padStart(2, '0');
                                document.getElementById('fechaProgramacion').value = `${yyyy}-${mm}-${dd}`;
                            } else {
                                document.getElementById('fechaProgramacion').value = actividad.fecha;
                            }
                        }
                        document.getElementById('horaProgramacion').value = actividad.hora || '';
                        document.getElementById('tituloProgramacion').value = actividad.titulo || '';
                        document.getElementById('detalleProgramacion').value = actividad.detalle || '';

                        if (actividad.costo && actividad.costo.toString().startsWith('$')) {
                            document.getElementById('costoFijo').checked = true;
                            toggleCostoMonto(true);
                            const monto = actividad.costo.toString().replace('$', '').trim();
                            document.getElementById('montoCostoProgramacion').value = monto;
                        } else {
                            document.getElementById('costoGratuito').checked = true;
                            toggleCostoMonto(false);
                        }

                    } else if (tipo === 'socios') {
                        // MAPEADO EXACTO SEGÚN TU IMAGEN
                        document.getElementById('Apellido').value = actividad.Apellido || '';
                        document.getElementById('Nombre').value = actividad.Nombre || '';
                        document.getElementById('nro_dni').value = actividad.nro_dni || '';
                        document.getElementById('email').value = actividad.email || '';

                        // CORRECCIÓN PARA EL CUMPLEAÑOS:
                        let cumple = actividad.f_cumple || '';
                        // Si el dato viene con el formato largo (contiene una 'T' de la zona horaria)
                        if (cumple.toString().includes('T')) {
                            const partes = cumple.split('T')[0].split('-'); // Separa por guiones: [YYYY, MM, DD]
                            cumple = `${partes[2]}/${partes[1]}`; // Lo arma como DD/MM
                        }
                        document.getElementById('f_cumple').value = cumple;

                        document.getElementById('tel_cel').value = actividad.tel_cel || '';
                        document.getElementById('lugar_residencia').value = actividad.lugar_residencia || '';
                    }
                    else if (tipo === 'user') {
                        document.getElementById('Apellido').value = actividad.Apellido || '';
                        document.getElementById('Nombre').value = actividad.Nombre || '';
                        document.getElementById('Usuario').value = actividad.Usuario || '';
                        document.getElementById('Password').value = actividad.Password || '';
                        document.getElementById('Permiso').value = actividad.Permiso || 'USER';
                    }
                } else {
                    showFeedback(`Error al obtener datos: ${data.message}`, false);
                }
            } catch (error) {
                setLoadingState(false);
                showFeedback(`Error de conexión: ${error.message}`, false);
            }
        }

        /**
         * Maneja el envío del formulario para crear o actualizar. (CREATE/UPDATE)
         */
        /**
 * Maneja el envío del formulario (Crear o Actualizar)
 */
        async function handleFormSubmission() {
            const form = document.getElementById('actividadForm');
            const actividadId = document.getElementById('actividadId').value; // Este es el ID que viene del modal
            const tipo = document.getElementById('actividadTipo').value;
            const btnTexto = document.getElementById('saveActividadBtn').textContent;

            // 1. Definimos la acción correctamente según el tipo y el texto del botón
            let accion;
            if (tipo === 'user') {
                // Si el botón dice "Guardar Usuario" es porque es uno nuevo (vínculo con socio)
                // Si dice "Actualizar", es un UPDATE de un usuario que ya existe
                accion = (btnTexto === 'Guardar Usuario') ? 'CREATE_USER' : 'UPDATE';
            } else {
                accion = actividadId ? 'UPDATE' : 'CREATE';
            }

            // 2. Validación de campos (tu lógica actual)
            const visibleInputs = form.querySelectorAll('input:not([type="hidden"]), select, textarea');
            let formValido = true;
            visibleInputs.forEach(input => {
                if (input.offsetParent !== null && input.hasAttribute('required') && !input.value.trim()) {
                    formValido = false;
                    input.classList.add('is-invalid');
                } else {
                    input.classList.remove('is-invalid');
                }
            });

            if (!formValido) {
                showFeedback("¡Epa! Te faltan completar campos obligatorios.", false);
                return;
            }

            // 3. Preparación del envío
            setLoadingState(true, 'Procesando datos');

            try {
                const formData = new FormData(form);
                formData.append('action', accion);
                formData.append('actividadTipo', tipo);
                formData.append('userSpreadsheetId', USER_SPREADSHEET_ID);

                // --- LÓGICA CRÍTICA PARA EL ID ---
                // Si estamos creando un usuario, el 'actividadId' contiene el ID del socio.
                // Lo seteamos como 'id' para que el backend sepa que ese es el ID de la fila/socio.
                if (actividadId) {
                    formData.set('id', actividadId);
                }

                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                setLoadingState(false);

                if (data.status === 'success') {
                    actividadModal.hide();
                    showFeedback("¡Listo! Guardado correctamente.", true);
                    fetchActividades(); // Recarga la tabla en la que estés
                } else {
                    showFeedback(`Error: ${data.message}`, false);
                }
            } catch (error) {
                setLoadingState(false);
                showFeedback(`Error de conexión: ${error.message}`, false);
                console.error("Error en submit:", error);
            }
        }

        /**
         * Llama a Apps Script para eliminar una actividad.
         */

        // Esta es la función que te falta para Socios y Usuarios
        /**
         * Función para confirmar y eliminar registros (Socios, Usuarios, etc.)
         */
        async function confirmDelete(id, tipo, nombre) {
            // Usamos el confirm del navegador pero con un texto más amigable
            // Si querés un modal de Bootstrap avisame y lo armamos, 
            // pero este es el que asegura que no borres por error.
            const mensaje = `¿Estás seguro de que querés eliminar a "${nombre}"?\nEsta acción no se puede deshacer.`;

            if (confirm(mensaje)) {
                setLoadingState(true, 'Eliminando registro...');

                try {
                    // Mandamos el tipo para que el Script sepa a qué planilla ir
                    const url = `${WEB_APP_URL}?action=DELETE&id=${id}&actividadTipo=${tipo}`;

                    const response = await fetch(url, {
                        method: 'POST'
                    });

                    const data = await response.json();
                    setLoadingState(false);

                    if (data.status === 'success') {
                        // AQUÍ USAMOS TU MENSAJE DE FEEDBACK (el que sale arriba en verde)
                        showFeedback(`¡Listo! "${nombre}" fue eliminado correctamente.`, true);

                        // Recargamos la tabla automáticamente
                        fetchActividades();
                    } else {
                        showFeedback("Error al eliminar: " + data.message, false);
                    }
                } catch (error) {
                    setLoadingState(false);
                    console.error('Error al eliminar:', error);
                    showFeedback("Hubo un fallo en la conexión al intentar eliminar.", false);
                }
            }
        }
        // =================================================================
        // FUNCIÓN PARA EL MODAL DE ACTIVIDADES DE HOY 
        // =================================================================

        /**
         * Consulta a Apps Script por actividades de Programación activas para hoy y muestra el modal si hay.
         */
        async function checkTodayActivities() {
            const today = new Date();
            // Creamos la fecha en formato YYYY-MM-DD local (no UTC) para el fetch
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            const formattedDate = `${year}-${month}-${day}`; // Formato YYYY-MM-DD para la query

            // Formato de visualización
            const todayDisplay = today.toLocaleDateString('es-AR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('todayDateDisplay').textContent = todayDisplay;

            try {
                // El backend (Código.gs) ahora compara correctamente solo la parte YYYY-MM-DD
                const response = await fetch(`${WEB_APP_URL}?action=READ_PROGRAMACION_HOY&fechaHoy=${formattedDate}`);
                const data = await response.json();

                // --- CAMBIO PARA DEBUGGING ---
                console.log('Actividades de hoy (READ_PROGRAMACION_HOY) data:', data);
                // -----------------------------

                if (data.status === 'success' && data.actividades.length > 0) {
                    const list = document.getElementById('actividadesHoyList');
                    list.innerHTML = ''; // Limpiar lista

                    // Ordenamos por hora, aunque no es estrictamente necesario, es mejor UX
                    data.actividades.sort((a, b) => a.hora.localeCompare(b.hora));

                    data.actividades.forEach(act => {
                        const listItem = document.createElement('li');
                        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        listItem.innerHTML = `
                            <div>
                                <h6 class="mb-0 text-dark">${act.titulo}</h6>
                                <small class="text-muted">${act.detalle}</small>
                            </div>
                            <span class="badge bg-info text-dark rounded-pill">${act.hora}</span>
                        `;
                        list.appendChild(listItem);
                    });

                    if (actividadHoyModal) {
                        actividadHoyModal.show();
                    }
                }
            } catch (error) {
                console.error('Error al chequear actividades de hoy:', error);
            }
        }


        // =================================================================
        // RENDERIZADO DE TABLAS
        // =================================================================
        // =================================================================
        // RENDERIZADO DE TABLAS (ACTUALIZADO)
        // =================================================================
        function renderTable(actividades, tipo) {
            // Pasamos a minúsculas para que sea infalible con "Socios", "Muestra", etc.
            const tipoLower = tipo.toLowerCase();

            // Definimos qué tabla usar según el tipo
            let tableId = tipoLower === 'muestra' ? 'muestrasTable' :
                tipoLower === 'socios' ? 'sociosTable' :
                    tipoLower === 'user' ? 'userTable' : 'programacionesTable';

            const tableElement = document.getElementById(tableId);

            // Si por algún motivo no existe la tabla en el HTML, cortamos acá
            if (!tableElement) return;

            const tableBody = tableElement.querySelector('tbody');
            tableBody.innerHTML = '';

            actividades.forEach(act => {
                const row = tableBody.insertRow();

                // Badge de activo uniforme para todos
                const badgeActivo = `<span class="badge ${act.activo === 'SI' ? 'bg-success' : 'bg-danger'}">${act.activo}</span>`;

                if (tipoLower === 'socios') {
                    const nombreSocio = `${act.Apellido}, ${act.Nombre}`;
                    const esActivo = act.activo === 'SI';
                    const fechaFormateada = act.f_cumple ? formatToDisplayDate(act.f_cumple) : '';

                    // Lógica para el color del botón de usuario (amarillo si activo, gris si no)
                    const claseBotonUser = esActivo ? 'btn-warning' : 'btn-secondary';

                    row.innerHTML = `
                        <td style="display:none;">${act.id}</td> 
                        <td>${nombreSocio}</td>
                        <td>${act.nro_dni}</td>
                        <td>${act.email}</td>
                        <td>${fechaFormateada}</td>
                        <td>${act.tel_cel}</td>
                        <td>${act.lugar_residencia}</td>
                        <td>${badgeActivo}</td>
                        <td class="action-btns">
                            <button class="btn btn-sm ${claseBotonUser}" onclick="showModal('user', '${act.id}')" ${esActivo ? '' : 'disabled'} title="Gestión de Usuario">
                                <i class="fas fa-user-lock"></i>
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="showModal('socios', '${act.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="confirmDelete('${act.id}', 'socios', '${nombreSocio}')"><i class="fas fa-trash-alt"></i></button>
                        </td>`;

                } else if (tipoLower === 'muestra') {
                    row.innerHTML = `
                        <td style="display:none;">${act.id}</td>
                        <td>${act.nombre}</td>
                        <td>${act.periodo}</td>
                        <td>${act.detalle}</td>
                        <td>${badgeActivo}</td>
                        <td class="action-btns">
                            <button class="btn btn-sm btn-primary" onclick="showModal('Muestra','${act.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="confirmDelete('${act.id}', 'Muestra', '${act.nombre}')"><i class="fas fa-trash-alt"></i></button>
                        </td>`;

                } else if (tipoLower === 'user') {
                    row.innerHTML = `
                        <td style="display:none;">${act.id}</td>
                        <td>${act.Apellido}</td>
                        <td>${act.Nombre}</td>
                        <td>${act.Usuario}</td>
                        <td>${act.Permiso}</td>
                        <td class="action-btns">
                            <button class="btn btn-sm btn-primary" onclick="showModal('user','${act.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="confirmDelete('${act.id}', 'user', '${act.Usuario}')"><i class="fas fa-trash-alt"></i></button>
                        </td>`;

                } else {
                    // Caso Programación
                    row.innerHTML = `
                        <td style="display:none;">${act.id}</td>
                        <td>${formatToDisplayDate(act.fecha)}</td>
                        <td>${act.hora}</td>
                        <td>${act.titulo}</td>
                        <td>${act.detalle}</td>
                        <td>${act.costo}</td>
                        <td>${badgeActivo}</td>
                        <td class="action-btns">
                            <button class="btn btn-sm btn-primary" onclick="showModal('Programacion','${act.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="confirmDelete('${act.id}', 'Programacion', '${act.titulo}')"><i class="fas fa-trash-alt"></i></button>
                        </td>`;
                }
            });

        }

        // --- COPIAR DESDE ACÁ ---

        // 1. Variable global para guardar qué vamos a borrar
        let deleteInfo = {}; // Variable global para guardar qué vamos a borrar

        // 1. Función que abre el modal (la llaman los botones de la tabla)
        function confirmDelete(id, tipo, nombre) {
            deleteInfo = { id, tipo, nombre };

            // Ponemos el nombre en el modal rojo
            const msgElement = document.getElementById('confirmDeleteMessage');
            if (msgElement) msgElement.textContent = `¿Realmente deseás eliminar a "${nombre}"?`;

            // Abrimos el modal de Bootstrap
            const modalElement = document.getElementById('confirmDeleteModal');
            const myModal = new bootstrap.Modal(modalElement);
            myModal.show();
        }

        // 2. Lógica del botón "Eliminar Definitivamente" dentro del modal
        // Usamos este formato para asegurar que el navegador registre el clic
        document.addEventListener('DOMContentLoaded', function () {
            const btnDoDelete = document.getElementById('btnDoDelete');
            // Buscá esta parte dentro del DOMContentLoaded al final de tu script
            if (btnDoDelete) {
                btnDoDelete.onclick = async function () {
                    const { id, tipo, nombre } = deleteInfo;
                    const modalElement = document.getElementById('confirmDeleteModal');
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);

                    if (modalInstance) modalInstance.hide();

                    // ACTIVAMOS EL CARTEL PARA EL BORRADO
                    setLoadingState(true, 'Consultando datos');

                    try {
                        const url = `${WEB_APP_URL}?action=DELETE&id=${id}&actividadTipo=${tipo}`;
                        const response = await fetch(url, { method: 'POST' });
                        const data = await response.json();

                        setLoadingState(false); // Apagamos el cartel

                        if (data.status === 'success') {
                            showFeedback(`"${nombre}" eliminado correctamente.`, true);
                            fetchActividades();
                        } else {
                            showFeedback("Error: " + data.message, false);
                        }
                    } catch (error) {
                        setLoadingState(false);
                        showFeedback("Error de conexión al intentar borrar.", false);
                    }
                };
            }
        });

    </script>

    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i> Confirmar Eliminación</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmDeleteMessage" class="fs-5"></p>
                    <p class="text-muted small">Esta acción no se puede deshacer.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" id="btnDoDelete" class="btn btn-danger">Eliminar Definitivamente</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>