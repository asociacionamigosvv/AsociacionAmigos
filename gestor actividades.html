<!DOCTYPE html>
<html lang="es">

<head>



    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
   <style>
        /* CONSTANTES DE COLOR */
        :root {
            --stm-main-color: #2D3748;
            --stm-teal: #34B3C5;
            --stm-red: #dc3545;
            --stm-gray: #f8f9fa;
            --stm-light-main: #4A5568;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--stm-gray);
            padding-top: 20px;
        }

        #mainContent {
            display: none;
        }

        /* Buscador */
        .search-container {
            display: flex;
            align-items: center;
        }

        .search-input-custom {
            border-radius: 50px !important;
            padding: 0 20px !important;
            border: 2px solid var(--stm-teal) !important;
            transition: all 0.3s ease;
            height: 38px;
            min-width: 250px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .search-input-custom:focus {
            box-shadow: 0 0 0 0.2rem rgba(52, 179, 197, 0.25) !important;
            outline: none;
        }

        .search-input-custom::placeholder {
            color: #a0a0a0;
        }

        .header-section {
            background-color: white;
            color: #2D3748;
            padding: 30px 15px;
            border-radius: 8px 8px 0 0;
            border-bottom: 1px solid #dee2e6;
            position: relative;
        }

        .header-logo {
            max-width: 180px;
            height: auto;
            margin-bottom: 15px;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        .card-header-custom {
            background-color: var(--stm-main-color);
            color: white;
            padding: 10px 15px;
            font-weight: 700;
        }

        .btn-custom-teal {
            background-color: var(--stm-teal);
            border-color: var(--stm-teal);
            color: white;
            transition: all 0.2s;
        }

        .btn-custom-teal:hover {
            background-color: #2CAAB7;
            border-color: #2CAAB7;
            color: white;
            transform: translateY(-1px);
        }

        .btn-custom-purple,
        .btn-stm-primary {
            background-color: var(--stm-main-color) !important;
            border-color: var(--stm-main-color) !important;
            color: white !important;
            transition: all 0.2s;
        }

        .btn-custom-logout {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
        }

        .nav-link.active,
        .nav-link:hover {
            color: var(--stm-main-color) !important;
        }

        .nav-link.active {
            border-bottom: 3px solid var(--stm-main-color) !important;
            border-top-color: transparent !important;
            border-left-color: transparent !important;
            border-right-color: transparent !important;
            background-color: white;
        }

        .tab-content {
            padding: 0 !important;
            border: none !important;
        }

        .table-responsive {
            margin-top: 0;
            border-radius: 0 0 8px 8px;
            overflow-x: hidden; /* Cambiado para manejar el responsive por filas */
        }

        .table thead th {
            background-color: #f8f9fa;
            color: var(--stm-main-color);
            border-bottom: 2px solid #dee2e6;
            font-size: 0.85rem;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .action-btns {
            display: flex !important;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }

        .action-btns .btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            border-radius: 6px;
        }

        /* Loading y Feedback */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000; visibility: hidden; opacity: 0; transition: opacity 0.3s;
        }
        .loading-overlay.visible { visibility: visible; opacity: 1; }

        .feedback {
            position: fixed; top: 20px; right: 20px; z-index: 2100;
            min-width: 250px; padding: 15px; display: none; border-radius: 8px;
        }

        /* --- AJUSTES PARA CELULAR --- */
        @media (max-width: 768px) {
            header.main-header {
                flex-direction: column;
                padding: 10px !important;
            }
            header.main-header h1 { font-size: 1.1rem; text-align: center; margin-bottom: 10px; }
            
            .header-section h1 { font-size: 1.5rem; }
            .header-section p { font-size: 0.9rem; }

            /* Contenedor de botones y búsqueda */
            .d-flex.justify-content-between.align-items-center.p-3 {
                flex-direction: column;
                gap: 15px;
            }
            .d-flex.gap-2.align-items-center {
                flex-direction: column;
                width: 100%;
            }
            .search-wrapper, .btn-custom-teal {
                width: 100% !important;
            }
            .search-input-custom { min-width: 100%; }

            /* MAGIA PARA LA TABLA: Convertir filas en tarjetas */
            .table, .table thead, .table tbody, .table th, .table td, .table tr { 
                display: block; 
            }
            
            .table thead tr { 
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            
            .table tr { 
                border: 1px solid #ccc; 
                margin-bottom: 10px;
                background: white;
                border-radius: 8px;
                padding: 5px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
            
            .table td { 
                border: none;
                border-bottom: 1px solid #eee; 
                position: relative;
                padding-left: 50% !important; 
                text-align: right !important;
                min-height: 40px;
                display: flex;
                align-items: center;
                justify-content: flex-end;
            }

            .table td:last-child { border-bottom: 0; }
            
            /* Agregamos los nombres de las columnas antes de cada dato */
            .table td:before { 
                position: absolute;
                left: 10px;
                width: 45%; 
                padding-right: 10px; 
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: var(--stm-main-color);
            }

            /* Muestras */
            #muestrasTable td:nth-of-type(2):before { content: "Nombre"; }
            #muestrasTable td:nth-of-type(3):before { content: "Período"; }
            #muestrasTable td:nth-of-type(4):before { content: "Detalle"; }
            #muestrasTable td:nth-of-type(5):before { content: "Activo"; }
            #muestrasTable td:nth-of-type(6):before { content: "Acciones"; }

            /* Programación */
            #programacionesTable td:nth-of-type(2):before { content: "Fecha"; }
            #programacionesTable td:nth-of-type(3):before { content: "Hora"; }
            #programacionesTable td:nth-of-type(4):before { content: "Título"; }
            #programacionesTable td:nth-of-type(5):before { content: "Detalle"; }
            #programacionesTable td:nth-of-type(6):before { content: "Costo"; }
            #programacionesTable td:nth-of-type(7):before { content: "Activo"; }
            #programacionesTable td:nth-of-type(8):before { content: "Acciones"; }

            /* Socios (El que más se corta) */
            #sociosTable td:nth-of-type(2):before { content: "Socio"; }
            #sociosTable td:nth-of-type(3):before { content: "DNI"; }
            #sociosTable td:nth-of-type(4):before { content: "Email"; }
            #sociosTable td:nth-of-type(5):before { content: "Cumple"; }
            #sociosTable td:nth-of-type(6):before { content: "Celular"; }
            #sociosTable td:nth-of-type(7):before { content: "Residencia"; }
            #sociosTable td:nth-of-type(8):before { content: "Activo"; }
            #sociosTable td:nth-of-type(9):before { content: "Acciones"; }

            .action-btns { justify-content: flex-end; width: 100%; }
        }
    </style>
</head>

<body>
    <header class="main-header mb-4 p-3 shadow-sm d-flex justify-content-between align-items-center"
        style="position: sticky; top: 0; z-index: 1000; background-color: var(--stm-main-color);">

        <div class="d-flex align-items-center">
            <img src="logo AAVV.png" alt="Logo" class="me-3" style="height: 40px; filter: brightness(0) invert(1);">
            <h1 class="h4 mb-0 text-white">Asociación Amigos Villa Victoria</h1>
        </div>

        <div class="d-flex align-items-center gap-3">
            <div id="userBadge" class="text-white d-flex align-items-center"
                style="background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2);">
                <i class="fas fa-user-circle me-2"></i>
                <span id="userNameDisplay" class="fw-bold text-white">...</span>
            </div>

            <button onclick="logout()" class="btn btn-sm btn-outline-light"
                style="border-radius: 8px; padding: 5px 12px; display: flex; align-items: center; border-color: rgba(255,255,255,0.5);">
                <i class="fas fa-sign-out-alt me-1"></i> Salir
            </button>
        </div>
    </header>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="d-flex align-items-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <span class="loading-text" id="loadingText">Cargando datos...</span>
        </div>
    </div>

    <div class="feedback" id="feedbackMessage"></div>

    <div id="mainContent">

        <div class="container main-container">
            <div class="header-section text-center p-3 mb-4 rounded-top-lg">


                <img src="logo AAVV.png" alt="Logo Villa Victoria" class="header-logo">

                <h1 style="color: black; font-weight: 700;">Gestor de información</h1>
                <p class="lead" style="color: #4A5568;">Centro Cultural Victoria Ocampo - Villa Victoria - Mar del
                    Plata.</p>


            </div>

            <div class="d-flex justify-content-between align-items-center p-3">
                <h2 class="h4 mb-0">Listado de Actividades</h2>
                <div class="d-flex gap-2 align-items-center">
                    <div id="searchContainer" class="search-wrapper" style="display: none; min-width: 250px;">

                        <input type="text" id="searchInput" class="form-control form-control-sm search-input-custom"
                            placeholder="Buscar por nombre o DNI..." onkeyup="filterSocios()">
                    </div>

                    <button id="btnNuevaMuestra" class="btn btn-custom-teal" onclick="showModal('Muestra')">
                        <i class="fas fa-plus-circle"></i> Nueva Muestra
                    </button>
                    <button id="btnNuevaProgramacion" class="btn btn-custom-teal" style="display: none;"
                        onclick="showModal('Programacion')">
                        <i class="fas fa-plus-circle"></i> Nueva Programación
                    </button>
                    <button id="btnNuevoSocio" class="btn btn-custom-teal" style="display: none;"
                        onclick="showModal('socios')">
                        <i class="fas fa-plus-circle"></i> Nuevo Socio
                    </button>
                </div>
            </div>

            <ul class="nav nav-tabs nav-justified" id="activityTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="muestras-tab" data-bs-toggle="tab" data-bs-target="#muestras"
                        type="button" role="tab" aria-controls="muestras" aria-selected="true"
                        onclick="setActiveTab('Muestra')">
                        <i class="fas fa-camera-retro"></i> Muestras
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="programaciones-tab" data-bs-toggle="tab"
                        data-bs-target="#programaciones" type="button" role="tab" aria-controls="programaciones"
                        aria-selected="false" onclick="setActiveTab('Programacion')">
                        <i class="fas fa-calendar-alt"></i> Programación
                    </button>
                </li>

                <button class="nav-link" id="socios-tab" data-bs-toggle="tab" data-bs-target="#socios" type="button"
                    role="tab" aria-controls="socios" aria-selected="false" onclick="setActiveTab('socios')">
                    <i class="fas fa-users"></i> Socios
                </button>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="muestras" role="tabpanel" aria-labelledby="muestras-tab">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle" id="muestrasTable">
                            <thead>
                                <tr>
                                    <th scope="col" style="width: 0; display:none;">ID</th>
                                    <th scope="col" style="width: 25%;">Nombre</th>
                                    <th scope="col" style="width: 20%;">Período</th>
                                    <th scope="col" style="width: 35%;">Detalle</th>
                                    <th scope="col" style="width: 5%; text-align: center;">Activo</th>
                                    <th scope="col" style="width: 15%; text-align: center;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="programaciones" role="tabpanel" aria-labelledby="programaciones-tab">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle" id="programacionesTable">
                            <thead>
                                <tr>
                                    <th scope="col" style="width: 0; display:none;">ID</th>
                                    <th scope="col" style="width: 10%;">Fecha</th>
                                    <th scope="col" style="width: 7%;">Hora</th>
                                    <th scope="col" style="width: 20%;">Título</th>
                                    <th scope="col" style="width: 23%;">Detalle</th>
                                    <th scope="col" style="width: 15%;">Costo</th>
                                    <th scope="col" style="width: 10%; text-align: center;">Activo</th>
                                    <th scope="col" style="width: 15%; text-align: center;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade" id="socios" role="tabpanel" aria-labelledby="socios-tab">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle" id="sociosTable">
                            <thead>
                                <tr>
                                    <th scope="col" style="display:none;">ID</th>
                                    <th scope="col" style="width: 20%;">Apellido y Nombre</th>
                                    <th scope="col" style="width: 10%;">DNI</th>
                                    <th scope="col" style="width: 15%;">Email</th>
                                    <th scope="col" style="width: 10%;">Cumple</th>
                                    <th scope="col" style="width: 12%;">Celular</th>
                                    <th scope="col" style="width: 13%;">Residencia</th>
                                    <th scope="col" style="width: 5%; text-align: center;">Activo</th>
                                    <th scope="col" style="width: 15%; text-align: center;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

        <div class="modal fade" id="actividadModal" tabindex="-1" aria-labelledby="actividadModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="actividadModalLabel">Alta/h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <form id="actividadForm" class="needs-validation" novalidate>
                        <div class="modal-body">
                            <input type="hidden" id="actividadTipo" name="actividadTipo" value="">
                            <input type="hidden" id="actividadId" name="actividadId" value="">

                            <div id="formContent">
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Estado de Actividad</label>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="activo" id="activoSI"
                                            value="true" required>
                                        <label class="form-check-label" for="activoSI">Activo (SI)</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="activo" id="activoNO"
                                            value="false" required>
                                        <label class="form-check-label" for="activoNO">Inactivo (NO)</label>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            <button type="button" class="btn btn-custom-purple" id="saveActividadBtn">
                                <i class="fas fa-save"></i> Guardar Cambios
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="deleteConfirmModalLabel"><i class="fas fa-trash-alt"></i> Confirmar
                            Eliminación</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>¿Estás seguro de que deseas eliminar esta actividad: <strong
                                id="deleteActividadInfo"></strong>?
                        </p>
                        <p class="text-danger">¡Esta acción no se puede deshacer!</p>
                        <input type="hidden" id="deleteId" value="">
                        <input type="hidden" id="deleteTipo" value="">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-danger"
                            onclick="deleteActividad(document.getElementById('deleteId').value, document.getElementById('deleteTipo').value)">Eliminar</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="actividadHoyModal" tabindex="-1" aria-labelledby="actividadHoyModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title" id="actividadHoyModalLabel"><i class="fas fa-bell me-2"></i> ¡ATENCIÓN!
                            Actividades para Hoy</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <p class="lead">Se encontraron actividades de Programación programadas para el día de hoy,
                            <strong id="todayDateDisplay"></strong>:
                        </p>
                        <ul id="actividadesHoyList" class="list-group list-group-flush">
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        <button type="button" class="btn btn-stm-primary" data-bs-dismiss="modal"
                            onclick="document.getElementById('programaciones-tab').click()">
                            Ver Programaciones
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i> Confirmar Eliminación
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p id="confirmDeleteMessage" class="fs-5"></p>
                        <p class="text-muted small">Esta acción no se puede deshacer.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" id="btnDoDelete" class="btn btn-danger">Eliminar Definitivamente</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.8/jquery.inputmask.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // URL DE TU WEB APP (DEBE SER REEMPLAZADA DESPUÉS DE CADA IMPLEMENTACIÓN NUEVA)
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwRD3CsV6sk0ArdjaWvTzKU6dj4fKA1KxtQDlEb87hxQo9jsMkXmXQhNSSHGCHjd2Fm4A/exec';
        // ID PLANILLA USUARIOS
        const USER_SPREADSHEET_ID = '1h3Q3aOYEsXqKC3xN4qj7K7SmkwpFQtZdd0POsZF77Dg';

        let actividadModal;
        let deleteConfirmModal;
        let actividadHoyModal; // Declaración de la variable para el modal de hoy
        let activeTab = 'Muestra';
        let actividadesCache = [];

        // AGREGADO: Función para cerrar sesión
        function logout() {
            // Limpiamos el localStorage con la clave correcta
            localStorage.removeItem('usuario');
            localStorage.removeItem('adminLoggedIn');

            // Mandamos al usuario al login
            window.location.href = 'login.html';
        }

        document.addEventListener('DOMContentLoaded', () => {
            // --- AGREGADO: VERIFICACIÓN DE SEGURIDAD ---
            const usuarioLogueado = JSON.parse(localStorage.getItem('usuario'));

            if (!usuarioLogueado) {
                // Si no hay datos en el localStorage, mandalo al login
                window.location.href = 'login.html';
                return;
            }

            const nameDisplay = document.getElementById('userNameDisplay');
            if (nameDisplay) {
                nameDisplay.innerText = usuarioLogueado.nombre || "Usuario";
            }
            localStorage.removeItem('usuario');
            localStorage.removeItem('adminLoggedIn');

            // Si llegó acá, es porque está logueado. Mostramos el contenido.
            document.getElementById('mainContent').style.display = 'block';
            console.log("Bienvenido: " + (usuarioLogueado.nombre || "Usuario"));
            // -------------------------------------------

            // Inicializar Modales
            actividadModal = new bootstrap.Modal(document.getElementById('actividadModal'));
            deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            // Inicialización correcta del Modal de Actividades para Hoy
            actividadHoyModal = new bootstrap.Modal(document.getElementById('actividadHoyModal'));

            // Asignar manejador de envío al botón del modal
            document.getElementById('saveActividadBtn').addEventListener('click', handleFormSubmission);

            // Inicializar la tabla activa y chequear actividades de hoy
            fetchActividades();
            checkTodayActivities(); // <--- ESTA FUNCIÓN SE LLAMA AL CARGAR
        });

        // =================================================================
        // UTILIDADES Y FORMATO
        // =================================================================

        /**
         * Convierte la fecha de formato ISO (YYYY-MM-DDTHH:MM:SS.sssZ) a DD/MM/AAAA (Tabla).
         * @param {string} dateString - Fecha en formato ISO o YYYY-MM-DD.
         * @returns {string} Fecha en formato 'DD/MM/AAAA' o la original si es inválida.
         */
        function formatToDisplayDate(dateString) {
            if (!dateString) return '';

            // Si ya viene en formato DD/MM (ej: "15/05"), lo devolvemos tal cual
            const regexDDMM = /^\d{1,2}\/\d{1,2}$/;
            if (regexDDMM.test(dateString.toString())) {
                return dateString;
            }

            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;

            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');

            // Si es para socios, quizás solo querés DD/MM, 
            // pero para Programación necesitás el año. 
            // Vamos a devolver DD/MM/YYYY por defecto y en el render lo manejamos.
            const year = date.getFullYear();
            return `${day}/${month}`;
        }

        /**
         * Ordena las actividades por fecha (si existe) o ID, de más reciente a más antigua.
         * (Más nuevo al más viejo).
         * @param {Array<Object>} actividades - Lista de actividades.
         * @param {string} tipo - 'Muestra' o 'Programacion'.
         * @returns {Array<Object>} Lista ordenada.
         */
        /**
         * Ordena las actividades.
         * Para Socios: Primero Inactivos (NO) luego Activos (SI), y ambos por orden alfabético.
         */
        function sortActividades(actividades, tipo) {
            if (!actividades || actividades.length === 0) return [];

            const tipoLower = tipo.toLowerCase();

            return actividades.sort((a, b) => {
                // --- LÓGICA PARA SOCIOS ---
                if (tipoLower === 'socios') {
                    // 1. Criterio de Activo/Inactivo (NO antes que SI)
                    // Comparamos los strings: "NO" viene antes que "SI" alfabéticamente
                    const activoA = (a.activo || "SI").toUpperCase();
                    const activoB = (b.activo || "SI").toUpperCase();

                    if (activoA !== activoB) {
                        // Usamos localeCompare para que "NO" quede arriba de "SI"
                        return activoA.localeCompare(activoB);
                    }

                    // 2. Criterio Alfabético (Apellido y Nombre)
                    const nombreA = (a.Apellido || "").toLowerCase();
                    const nombreB = (b.Apellido || "").toLowerCase();
                    return nombreA.localeCompare(nombreB);
                }

                // --- LOGICA PARA PROGRAMACIÓN (Mantiene tu orden original) ---
                if (tipo === 'Programacion' && a.fecha && b.fecha) {
                    if (a.fecha !== b.fecha) {
                        return b.fecha.localeCompare(a.fecha);
                    }
                    if (a.hora && b.hora) {
                        return b.hora.localeCompare(a.hora);
                    }
                    return 0;
                }

                // --- LOGICA PARA MUESTRAS O ID ---
                if (a.id && b.id) {
                    const idA = parseFloat(a.id) || 0;
                    const idB = parseFloat(b.id) || 0;
                    return idB - idA;
                }

                return 0;
            });
        }

        // =================================================================
        // HTML DINÁMICO PARA EL FORMULARIO 
        // =================================================================

        const MUESTRA_FORM_HTML = `
            <div class="mb-3">
                <label for="nombreMuestra" class="form-label">Nombre de la Muestra</label>
                <input type="text" class="form-control" id="nombreMuestra" name="nombreMuestra" required>
                <div class="invalid-feedback">El nombre es obligatorio.</div>
            </div>

            <div class="mb-3">
                <label class="form-label">Período</label>
                <div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="tipoPeriodoMuestra" id="periodoPermanente" value="Permanente" checked onclick="togglePeriodoTexto(false)">
                        <label class="form-check-label" for="periodoPermanente">Permanente</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="tipoPeriodoMuestra" id="periodoTemporaria" value="Temporaria" onclick="togglePeriodoTexto(true)">
                        <label class="form-check-label" for="periodoTemporaria">Temporaria</label>
                    </div>
                </div>
            </div>

            <div class="mb-3" id="periodoMuestraTextoGroup" style="display:none;">
                <label for="periodoMuestraTexto" class="form-label">Descripción del Período Temporario (Ej: 10/2024 - 03/2025)</label>
                <input type="text" class="form-control" id="periodoMuestraTexto" name="periodoMuestraTexto">
                <div class="invalid-feedback">Debes ingresar una descripción si es Temporaria.</div>
            </div>

            <div class="mb-3">
                <label for="detalleMuestra" class="form-label">Detalle</label>
                <textarea class="form-control" id="detalleMuestra" name="detalleMuestra" required rows="3"></textarea>
            </div>
        `;

        const PROGRAMACION_FORM_HTML = `
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="fechaProgramacion" class="form-label">Fecha</label>
                    <input type="date" class="form-control" id="fechaProgramacion" name="fechaProgramacion" required>
                    <div class="invalid-feedback">La fecha es obligatoria.</div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="horaProgramacion" class="form-label">Hora</label>
                    <input type="text" class="form-control" id="horaProgramacion" name="horaProgramacion" required>
                </div>
            </div>
            <div class="mb-3">
                <label for="tituloProgramacion" class="form-label">Título de la Programación</label>
                <input type="text" class="form-control" id="tituloProgramacion" name="tituloProgramacion" required>
                <div class="invalid-feedback">El título es obligatorio.</div>
            </div>
            <div class="mb-3">
                <label for="detalleProgramacion" class="form-label">Detalle</label>
                <textarea class="form-control" id="detalleProgramacion" name="detalleProgramacion" rows="3" required></textarea>
            </div>

            <div class="mb-3">
                <label class="form-label">Costo</label>
                <div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="tipoCostoProgramacion" id="costoGratuito" value="Gratuito" checked onclick="toggleCostoMonto(false)">
                        <label class="form-check-label" for="costoGratuito">Libre y gratuita</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="tipoCostoProgramacion" id="costoFijo" value="Fijo" onclick="toggleCostoMonto(true)">
                        <label class="form-check-label" for="costoFijo">Costo Fijo</label>
                    </div>
                </div>
            </div>
            
            <div class="mb-3" id="costoMontoGroup" style="display:none;">
                <label for="montoCostoProgramacion" class="form-label">Monto (Ej: 5000)</label>
                <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="text" step="0.01" min="0" class="form-control" id="montoCostoProgramacion" name="montoCostoProgramacion" placeholder="0">
                </div>
                <div class="invalid-feedback">Debes ingresar el monto.</div>
            </div>
        `;
        const SOCIOS_FORM_HTML = `
    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">Apellido</label>
            <input type="text" class="form-control" name="Apellido" id="Apellido" required>
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" class="form-control" name="Nombre" id="Nombre" required>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">DNI</label>
            <input type="text" class="form-control" name="nro_dni" id="nro_dni" required>
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" name="email" id="email" required>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">F. Cumpleaños</label>
            <input type="text" class="form-control" name="f_cumple" id="f_cumple" placeholder="DD/MM">
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">Celular</label>
            <input type="text" class="form-control" name="tel_cel" id="tel_cel">
        </div>
    </div>
    <div class="mb-3">
        <label class="form-label">Lugar de Residencia</label>
        <input type="text" class="form-control" name="lugar_residencia" id="lugar_residencia">
    </div>
`;

        const USER_FORM_HTML = `
    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">Apellido</label>
            <input type="text" class="form-control" name="userApellido" id="Apellido" required>
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" class="form-control" name="userNombre" id="Nombre" required>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6 mb-3">
            <label class="form-label">Usuario (Login)</label>
            <input type="text" class="form-control" name="userUsuario" id="Usuario" required>
        </div>
        <div class="col-md-6 mb-3">
            <label class="form-label">Password</label>
            <input type="password" class="form-control" name="userPassword" id="Password" required>
        </div>
    </div>
    <div class="mb-3">
        <label class="form-label">Permiso</label>
        <select class="form-select" name="userPermiso" id="Permiso" required>
             <option value="USER">USER</option>
             <option value="ADMIN">ADMIN</option>
           
        </select>
    </div>
`;
        const PAGOS_FORM_HTML = `
    <div class="p-2">
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label font-weight-bold">Socio</label>
                <input type="text" class="form-control bg-light" name="socio" id="pagoSocio" readonly>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Monto a Cobrar</label>
                <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="number" class="form-control" name="monto" id="pagoMonto" required>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Fecha</label>
                <input type="date" class="form-control" name="fecha_pago" id="pagoFecha" required>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Método</label>
                <select class="form-select" name="tipo_pago" id="pagoTipo">
                    <option value="Efectivo">Efectivo</option>
                    <option value="Transferencia">Transferencia</option>
                    <option value="Tarjeta">Tarjeta</option>
                </select>
            </div>
        </div>
        <input type="hidden" name="id_user" id="pagoIdUser">
        <input type="hidden" name="confirmado" value="SI">

        <hr class="my-4">
        
        <div class="historial-seccion">
            <h6 class="mb-3 text-primary"><i class="fas fa-list-ul me-2"></i>Últimos Pagos Registrados</h6>
            <div id="historialPagosLista" class="table-responsive" style="max-height: 200px; border: 1px solid #dee2e6; border-radius: 4px;">
                <p class="text-muted p-3 text-center">Buscando historial...</p>
            </div>
        </div>
    </div>
`;
        function togglePeriodoTexto(show) {
            const group = document.getElementById('periodoMuestraTextoGroup');
            group.style.display = show ? 'block' : 'none';
            const input = document.getElementById('periodoMuestraTexto');
            if (show) {
                // Se mantiene el campo NO requerido, como fue solicitado.
            } else {
                input.removeAttribute('required');
                input.value = ''; // Limpiar si se oculta
            }
        }

        function toggleCostoMonto(show) {
            const group = document.getElementById('costoMontoGroup');
            group.style.display = show ? 'block' : 'none';
            const input = document.getElementById('montoCostoProgramacion');
            if (show) {
                input.setAttribute('required', 'required');
            } else {
                input.removeAttribute('required');
                input.value = ''; // Limpiar si se oculta
            }
        }

        // =================================================================
        // FUNCIÓN NUEVA: Aplica la máscara de hora (ELIMINADA)
        // =================================================================
        function applyProgramacionMasks() {
            // La función de máscara fue eliminada. El campo 'horaProgramacion' ahora se maneja como un input de texto simple.
            console.log("Máscara de hora deshabilitada.");
        }

        // =================================================================
        // MANEJO DE ESTADO Y UI
        // =================================================================

        function setActiveTab(tipo) {
            activeTab = tipo;

            // 1. Manejo de visibilidad de botones
            document.getElementById('btnNuevaMuestra').style.display = (tipo === 'Muestra') ? 'block' : 'none';
            document.getElementById('btnNuevaProgramacion').style.display = (tipo === 'Programacion') ? 'block' : 'none';
            document.getElementById('btnNuevoSocio').style.display = (tipo === 'socios') ? 'block' : 'none';

            // 2. Manejo del buscador (solo para socios)
            const searchContainer = document.getElementById('searchContainer');
            if (tipo === 'socios') {
                searchContainer.style.display = 'block';
                document.getElementById('searchInput').value = ''; // Limpiar búsqueda al entrar
            } else {
                searchContainer.style.display = 'none';
            }

            fetchActividades();
        }

        function setLoadingState(isLoading, actionText = 'Cargando') {
            const overlay = document.getElementById('loadingOverlay');
            const text = document.getElementById('loadingText');
            if (isLoading) {
                text.textContent = `${actionText}...`;
                overlay.classList.add('visible');
            } else {
                overlay.classList.remove('visible');
            }
        }

        function showFeedback(message, isSuccess) {
            const feedback = document.getElementById('feedbackMessage');
            feedback.textContent = message;
            feedback.className = 'feedback show';
            feedback.classList.add(isSuccess ? 'success' : 'error');

            setTimeout(() => {
                feedback.classList.remove('show');
            }, 3000);
        }

        /**
  * Muestra el modal de edición/creación
  */
        function showModal(tipo, id = null) {
            const modalLabel = document.getElementById('actividadModalLabel');
            const formContent = document.getElementById('formContent');
            const form = document.getElementById('actividadForm');
            const estadoActividadGroup = document.querySelector('input[name="activo"]').closest('.mb-3');

            form.reset();
            form.classList.remove('was-validated');

            document.getElementById('actividadTipo').value = tipo;
            document.getElementById('actividadId').value = id || '';
            document.getElementById('saveActividadBtn').textContent = 'Guardar Cambios';
            document.getElementById('saveActividadBtn').className = 'btn btn-primary'; // Reset color por defecto

            // Por defecto mostramos el grupo "Activo", lo ocultamos solo en casos específicos
            estadoActividadGroup.style.display = 'block';

            if (tipo === 'Muestra') {
                formContent.innerHTML = MUESTRA_FORM_HTML;
                togglePeriodoTexto(false);
            } else if (tipo === 'socios') {
                formContent.innerHTML = SOCIOS_FORM_HTML;
            } else if (tipo === 'pagos') {
                // --- LÓGICA DE GESTIONAR PAGOS ---
                formContent.innerHTML = PAGOS_FORM_HTML;
                modalLabel.innerHTML = `<i class="fas fa-money-check-alt me-2"></i>Gestionar Pagos`;
                document.getElementById('saveActividadBtn').textContent = 'Registrar Pago';
                document.getElementById('saveActividadBtn').className = 'btn btn-success';
                estadoActividadGroup.style.display = 'none';

                if (id) {
                    // Buscamos el socio en la tabla para los datos básicos
                    const filaSocio = Array.from(document.querySelectorAll('#sociosTable tbody tr')).find(tr =>
                        tr.cells[0].innerText === id.toString()
                    );

                    if (filaSocio) {
                        const nombreCompleto = filaSocio.cells[1].innerText;
                        document.getElementById('pagoSocio').value = nombreCompleto;
                        document.getElementById('pagoIdUser').value = id;
                        document.getElementById('pagoFecha').value = new Date().toISOString().split('T')[0]; // Fecha hoy por defecto

                        // DISPARAMOS EL HISTORIAL
                        renderHistorialPagos(id);
                    }
                }
            } else if (tipo === 'user') {
                formContent.innerHTML = USER_FORM_HTML;
                estadoActividadGroup.style.display = 'none';
                modalLabel.innerHTML = `<i class="fas fa-user-cog me-2"></i>Gestión de Usuario`;
                document.getElementById('saveActividadBtn').textContent = 'Guardar Usuario';
                document.getElementById('saveActividadBtn').className = 'btn btn-warning';

                if (id) {
                    const filaSocio = Array.from(document.querySelectorAll('#sociosTable tbody tr')).find(tr =>
                        tr.cells[0].innerText === id.toString()
                    );

                    if (filaSocio) {
                        const nombreCompleto = filaSocio.cells[1].innerText.split(',');
                        const apellido = nombreCompleto[0].trim();
                        const nombre = nombreCompleto[1] ? nombreCompleto[1].trim() : '';

                        document.getElementById('Apellido').value = apellido;
                        document.getElementById('Nombre').value = nombre;
                        document.getElementById('Apellido').readOnly = true;
                        document.getElementById('Nombre').readOnly = true;
                        document.getElementById('Apellido').style.backgroundColor = "#e9ecef";
                        document.getElementById('Nombre').style.backgroundColor = "#e9ecef";
                    }

                    setLoadingState(true, 'Verificando usuario...');
                    fetch(`${WEB_APP_URL}?action=READ_BY_ID&id=${id}&actividadTipo=user`)
                        .then(res => res.json())
                        .then(data => {
                            setLoadingState(false);
                            if (data.status === 'success' && data.actividad) {
                                modalLabel.textContent = `Actualizar Usuario: ${data.actividad.Usuario}`;
                                document.getElementById('Usuario').value = data.actividad.Usuario || '';
                                document.getElementById('Password').value = data.actividad.Password || '';
                                document.getElementById('Permiso').value = data.actividad.Permiso || 'USER';
                                document.getElementById('saveActividadBtn').textContent = 'Actualizar Usuario';
                            } else {
                                const apellidoLimpio = document.getElementById('Apellido').value.toLowerCase().replace(/\s+/g, '');
                                const inicialNombre = document.getElementById('Nombre').value.charAt(0).toLowerCase();
                                document.getElementById('Usuario').value = inicialNombre + apellidoLimpio;
                            }
                        })
                        .catch(err => {
                            setLoadingState(false);
                            console.error("Error buscando usuario:", err);
                        });
                }
            } else {
                formContent.innerHTML = PROGRAMACION_FORM_HTML;
                toggleCostoMonto(false);
            }

            // Título por defecto para edición (si no es pago ni usuario)
            if (id && tipo !== 'user' && tipo !== 'pagos') {
                modalLabel.textContent = `Editar ${tipo}`;
                document.getElementById('saveActividadBtn').textContent = 'Actualizar';
                readActividadById(id, tipo);
            }

            actividadModal.show();
        }

        // =================================================================
        // FUNCIONES CRUD DEL FRONTEND 
        // =================================================================

        /**
         * Llama a Apps Script para obtener todos los datos.
         */
        async function fetchActividades() {
            setLoadingState(true, 'Consultando datos');
            try {
                // El backend espera el nombre de la hoja en mayúsculas/minúsculas correctas
                const response = await fetch(`${WEB_APP_URL}?action=READ_ALL&actividadTipo=${activeTab}`);
                const data = await response.json();

                setLoadingState(false);

                if (data.status === 'success') {
                    actividadesCache = data.actividades;
                    // Ordenar antes de renderizar (Más reciente a más antiguo)
                    const actividadesOrdenadas = sortActividades(data.actividades, activeTab);
                    renderTable(actividadesOrdenadas, activeTab);
                } else {
                    showFeedback(`Error al cargar ${activeTab}: ${data.message}`, false);
                    renderTable([], activeTab);
                }
            } catch (error) {
                setLoadingState(false);
                showFeedback(`Error de conexión: ${error.message}`, false);
                renderTable([], activeTab);
            }
        }

        /**
         * Llama a Apps Script para leer una actividad por ID y rellenar el modal.
         */
        async function readActividadById(id, tipo) {
            setLoadingState(true, 'Cargando datos para editar');
            try {
                const response = await fetch(`${WEB_APP_URL}?action=READ_BY_ID&id=${id}&actividadTipo=${tipo}`);
                const data = await response.json();

                setLoadingState(false);
                if (data.status === 'success' && data.actividad) {
                    const actividad = data.actividad;
                    // Usamos .id para todos porque el servidor ya lo normalizó
                    document.getElementById('actividadId').value = actividad.id;
                    document.getElementById('actividadTipo').value = tipo;

                    // Estado Activo: En socios la columna es 'activo' (minúscula)
                    const valorActivoRaw = tipo === 'socios' ? actividad.activo : actividad.ACTIVO;
                    const activoValue = (valorActivoRaw && valorActivoRaw.toUpperCase() === 'SI') ? 'true' : 'false';
                    document.getElementById(activoValue === 'true' ? 'activoSI' : 'activoNO').checked = true;

                    // 2. Campos Específicos por Tipo
                    if (tipo === 'Muestra') {
                        document.getElementById('nombreMuestra').value = actividad.nombre;
                        document.getElementById('detalleMuestra').value = actividad.detalle;

                        if (actividad.periodo && actividad.periodo.toString().startsWith('Temporaria')) {
                            document.getElementById('periodoTemporaria').checked = true;
                            togglePeriodoTexto(true);
                            const periodoTexto = actividad.periodo.toString().replace('Temporaria:', '').trim();
                            document.getElementById('periodoMuestraTexto').value = periodoTexto;
                        } else {
                            document.getElementById('periodoPermanente').checked = true;
                            togglePeriodoTexto(false);
                        }

                    } else if (tipo === 'Programacion') {
                        if (actividad.fecha) {
                            const dateObj = new Date(actividad.fecha);
                            if (!isNaN(dateObj)) {
                                const yyyy = dateObj.getUTCFullYear();
                                const mm = String(dateObj.getUTCMonth() + 1).padStart(2, '0');
                                const dd = String(dateObj.getUTCDate()).padStart(2, '0');
                                document.getElementById('fechaProgramacion').value = `${yyyy}-${mm}-${dd}`;
                            } else {
                                document.getElementById('fechaProgramacion').value = actividad.fecha;
                            }
                        }
                        document.getElementById('horaProgramacion').value = actividad.hora || '';
                        document.getElementById('tituloProgramacion').value = actividad.titulo || '';
                        document.getElementById('detalleProgramacion').value = actividad.detalle || '';

                        if (actividad.costo && actividad.costo.toString().startsWith('$')) {
                            document.getElementById('costoFijo').checked = true;
                            toggleCostoMonto(true);
                            const monto = actividad.costo.toString().replace('$', '').trim();
                            document.getElementById('montoCostoProgramacion').value = monto;
                        } else {
                            document.getElementById('costoGratuito').checked = true;
                            toggleCostoMonto(false);
                        }

                    } else if (tipo === 'socios') {
                        // MAPEADO EXACTO SEGÚN TU IMAGEN
                        document.getElementById('Apellido').value = actividad.Apellido || '';
                        document.getElementById('Nombre').value = actividad.Nombre || '';
                        document.getElementById('nro_dni').value = actividad.nro_dni || '';
                        document.getElementById('email').value = actividad.email || '';

                        // CORRECCIÓN PARA EL CUMPLEAÑOS:
                        let cumple = actividad.f_cumple || '';
                        // Si el dato viene con el formato largo (contiene una 'T' de la zona horaria)
                        if (cumple.toString().includes('T')) {
                            const partes = cumple.split('T')[0].split('-'); // Separa por guiones: [YYYY, MM, DD]
                            cumple = `${partes[2]}/${partes[1]}`; // Lo arma como DD/MM
                        }
                        document.getElementById('f_cumple').value = cumple;

                        document.getElementById('tel_cel').value = actividad.tel_cel || '';
                        document.getElementById('lugar_residencia').value = actividad.lugar_residencia || '';
                    }
                    else if (tipo === 'user') {
                        document.getElementById('Apellido').value = actividad.Apellido || '';
                        document.getElementById('Nombre').value = actividad.Nombre || '';
                        document.getElementById('Usuario').value = actividad.Usuario || '';
                        document.getElementById('Password').value = actividad.Password || '';
                        document.getElementById('Permiso').value = actividad.Permiso || 'USER';
                    }
                } else {
                    showFeedback(`Error al obtener datos: ${data.message}`, false);
                }
            } catch (error) {
                setLoadingState(false);
                showFeedback(`Error de conexión: ${error.message}`, false);
            }
        }

        /**
         * Maneja el envío del formulario para crear o actualizar. (CREATE/UPDATE)
         */
        async function handleFormSubmission() {
            const form = document.getElementById('actividadForm');
            const actividadId = document.getElementById('actividadId').value;
            const tipo = document.getElementById('actividadTipo').value;
            const btnTexto = document.getElementById('saveActividadBtn').textContent;

            // 1. Definimos la acción correctamente según el tipo y el texto del botón
            let accion;
            if (tipo === 'user') {
                accion = (btnTexto === 'Guardar Usuario') ? 'CREATE_USER' : 'UPDATE';
            } else if (tipo === 'pagos') {
                accion = 'CREATE'; // Los pagos siempre se crean, no se editan por ahora
            } else {
                accion = actividadId ? 'UPDATE' : 'CREATE';
            }

            // 2. Validación de campos
            const visibleInputs = form.querySelectorAll('input:not([type="hidden"]), select, textarea');
            let formValido = true;
            visibleInputs.forEach(input => {
                if (input.offsetParent !== null && input.hasAttribute('required') && !input.value.trim()) {
                    formValido = false;
                    input.classList.add('is-invalid');
                } else {
                    input.classList.remove('is-invalid');
                }
            });

            if (!formValido) {
                showFeedback("¡Epa! Te faltan completar campos obligatorios.", false);
                return;
            }

            // 3. Preparación del envío
            setLoadingState(true, 'Procesando datos');

            try {
                const formData = new FormData(form);
                formData.append('action', accion);
                formData.append('actividadTipo', tipo);
                formData.append('userSpreadsheetId', USER_SPREADSHEET_ID);

                if (actividadId) {
                    formData.set('id', actividadId);
                }

                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                setLoadingState(false);

                if (data.status === 'success') {
                    // NUEVA LÓGICA DE SEGURIDAD PARA SOCIOS INACTIVOS
                    const esInactivo = formData.get('activo') === 'false';

                    if (tipo === 'socios' && actividadId && esInactivo) {
                        // Si desactivamos un socio existente, mandamos a borrar su usuario por seguridad
                        // No hace falta esperar la respuesta para cerrar el modal principal
                        fetch(`${WEB_APP_URL}?action=DELETE&id=${actividadId}&actividadTipo=user`, { method: 'POST' })
                            .then(res => res.json())
                            .then(userData => {
                                if (userData.status === 'success') {
                                    console.log("Usuario eliminado por inactividad del socio.");
                                }
                            })
                            .catch(err => console.error("Error al quitar acceso:", err));
                    }

                    actividadModal.hide();
                    showFeedback("¡Listo! Datos actualizados y acceso revocado si correspondía.", true);
                    fetchActividades();
                } else {
                    showFeedback(`Error: ${data.message}`, false);
                }
            } catch (error) {
                setLoadingState(false);
                showFeedback(`Error de conexión: ${error.message}`, false);
                console.error("Error en submit:", error);
            }
        }

        /**
         * Función para renderizar el historial de pagos en el modal
         */
        async function renderHistorialPagos(idSocio) {
            const listaDiv = document.getElementById('historialPagosLista');
            listaDiv.innerHTML = '<p class="text-muted p-3 text-center">Buscando historial...</p>';

            try {
                const response = await fetch(`${WEB_APP_URL}?action=READ_PAGOS_BY_USER&idUser=${idSocio}`);
                const data = await response.json();

                if (data.status === 'success' && data.pagos && data.pagos.length > 0) {
                    let html = `
                <table class="table table-sm mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-3">Fecha</th>
                            <th>Monto</th>
                            <th>Método</th>
                        </tr>
                    </thead>
                    <tbody>`;

                    data.pagos.forEach(p => {
                        const f = p.fecha_pago ? formatToDisplayDate(p.fecha_pago) : 'S/F';
                        html += `
                    <tr>
                        <td class="ps-3">${f}</td>
                        <td class="fw-bold">$${p.monto}</td>
                        <td>${p.tipo_pago}</td>
                    </tr>`;
                    });

                    html += '</tbody></table>';
                    listaDiv.innerHTML = html;
                } else {
                    listaDiv.innerHTML = '<p class="text-muted p-3 text-center">Sin pagos registrados.</p>';
                }
            } catch (e) {
                console.error("Error historial:", e);
                listaDiv.innerHTML = '<p class="text-danger p-3 text-center">Error al cargar historial.</p>';
            }
        }

        /**
         * Función para confirmar y eliminar registros (Socios, Usuarios, etc.)
         */
        async function confirmDelete(id, tipo, nombre) {
            deleteInfo = { id, tipo, nombre };

            const msgElement = document.getElementById('confirmDeleteMessage');
            if (msgElement) msgElement.textContent = `¿Realmente deseás eliminar a "${nombre}"?`;

            const modalElement = document.getElementById('confirmDeleteModal');
            const myModal = new bootstrap.Modal(modalElement);
            myModal.show();
        }

        /**
         * Consulta a Apps Script por actividades de Programación activas para hoy y muestra el modal si hay.
         */
        async function checkTodayActivities() {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            const formattedDate = `${year}-${month}-${day}`;

            const todayDisplay = today.toLocaleDateString('es-AR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            if (document.getElementById('todayDateDisplay')) {
                document.getElementById('todayDateDisplay').textContent = todayDisplay;
            }

            try {
                const response = await fetch(`${WEB_APP_URL}?action=READ_PROGRAMACION_HOY&fechaHoy=${formattedDate}`);
                const data = await response.json();

                if (data.status === 'success' && data.actividades && data.actividades.length > 0) {
                    const list = document.getElementById('actividadesHoyList');
                    if (list) {
                        list.innerHTML = '';
                        data.actividades.sort((a, b) => a.hora.localeCompare(b.hora));
                        data.actividades.forEach(act => {
                            const listItem = document.createElement('li');
                            listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                            listItem.innerHTML = `
                                <div>
                                    <h6 class="mb-0 text-dark">${act.titulo}</h6>
                                    <small class="text-muted">${act.detalle}</small>
                                </div>
                                <span class="badge bg-info text-dark rounded-pill">${act.hora}</span>
                            `;
                            list.appendChild(listItem);
                        });
                        if (actividadHoyModal) actividadHoyModal.show();
                    }
                }
            } catch (error) {
                console.error('Error al chequear actividades de hoy:', error);
            }
        }

        // =================================================================
        // RENDERIZADO DE TABLAS (ACTUALIZADO)
        // =================================================================
        function renderTable(actividades, tipo) {
            const tipoLower = tipo.toLowerCase();
            let tableId = tipoLower === 'muestra' ? 'muestrasTable' :
                tipoLower === 'socios' ? 'sociosTable' :
                    tipoLower === 'user' ? 'userTable' : 'programacionesTable';

            const tableElement = document.getElementById(tableId);
            if (!tableElement) return;

            const tableBody = tableElement.querySelector('tbody');
            tableBody.innerHTML = '';

            actividades.forEach(act => {
                const row = tableBody.insertRow();
                const badgeActivo = `<span class="badge ${act.activo === 'SI' ? 'bg-success' : 'bg-danger'}">${act.activo}</span>`;

                if (tipoLower === 'socios') {
                    const nombreSocio = `${act.Apellido}, ${act.Nombre}`;
                    const esActivo = act.activo === 'SI';
                    const fechaFormateada = act.f_cumple ? formatToDisplayDate(act.f_cumple) : '';
                    const claseBotonUser = esActivo ? 'btn-warning' : 'btn-secondary';

                    row.innerHTML = `
                <td style="display:none;">${act.id}</td> 
                <td>${nombreSocio}</td>
                <td>${act.nro_dni}</td>
                <td>${act.email}</td>
                <td>${fechaFormateada}</td>
                <td>${act.tel_cel}</td>
                <td>${act.lugar_residencia}</td>
                <td class="text-center">${badgeActivo}</td>
                <td class="text-center">
                    <div class="action-btns">
                        <button class="btn btn-sm ${claseBotonUser}" onclick="showModal('user', '${act.id}')" ${esActivo ? '' : 'disabled'} title="Gestión de Usuario">
                            <i class="fas fa-user-lock"></i>
                        </button>
                        <button class="btn btn-sm btn-success" onclick="showModal('pagos', '${act.id}')" title="Gestión de Pagos">
                            <i class="fas fa-dollar-sign"></i>
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="showModal('socios', '${act.id}')" title="Editar Socio">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="confirmDelete('${act.id}', 'socios', '${nombreSocio}')" title="Eliminar">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </td>`;


                } else if (tipoLower === 'muestra') {
                    row.innerHTML = `
                        <td style="display:none;">${act.id}</td>
                        <td>${act.nombre}</td>
                        <td>${act.periodo}</td>
                        <td>${act.detalle}</td>
                        <td class="text-center">${badgeActivo}</td>
                        <td class="action-btns-cell"> <div class="action-btns"> <button class="btn btn-sm btn-primary" onclick="showModal('Muestra','${act.id}')" title="Editar"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-danger" onclick="confirmDelete('${act.id}', 'Muestra', '${act.nombre}')" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </td>`;

                } else if (tipoLower === 'user') {
                    row.innerHTML = `
                        <td style="display:none;">${act.id}</td>
                        <td>${act.Apellido}</td>
                        <td>${act.Nombre}</td>
                        <td>${act.Usuario}</td>
                        <td>${act.Permiso}</td>
                        <td class="text-center">
                            <div class="action-btns">
                                <button class="btn btn-sm btn-primary" onclick="showModal('user','${act.id}')"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-danger" onclick="confirmDelete('${act.id}', 'user', '${act.Usuario}')"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </td>`;

                } else {
                    row.innerHTML = `
                        <td style="display:none;">${act.id}</td>
                        <td>${formatToDisplayDate(act.fecha)}</td>
                        <td>${act.hora}</td>
                        <td>${act.titulo}</td>
                        <td>${act.detalle}</td>
                        <td>${act.costo}</td>
                        <td class="text-center">${badgeActivo}</td>
                        <td class="action-btns-cell">
                            <div class="action-btns">
                                <button class="btn btn-sm btn-primary" onclick="showModal('Programacion','${act.id}')" title="Editar"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-danger" onclick="confirmDelete('${act.id}', 'Programacion', '${act.titulo}')" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </td>`;
                }
            });

        }

        let deleteInfo = {};

        document.addEventListener('DOMContentLoaded', function () {
            const btnDoDelete = document.getElementById('btnDoDelete');
            if (btnDoDelete) {
                btnDoDelete.onclick = async function () {
                    const { id, tipo, nombre } = deleteInfo;
                    const modalElement = document.getElementById('confirmDeleteModal');
                    const modalInstance = bootstrap.Modal.getInstance(modalElement);

                    if (modalInstance) modalInstance.hide();
                    setLoadingState(true, 'Eliminando...');

                    try {
                        const url = `${WEB_APP_URL}?action=DELETE&id=${id}&actividadTipo=${tipo}`;
                        const response = await fetch(url, { method: 'POST' });
                        const data = await response.json();

                        setLoadingState(false);

                        if (data.status === 'success') {
                            showFeedback(`"${nombre}" eliminado correctamente.`, true);
                            fetchActividades();
                        } else {
                            showFeedback("Error: " + data.message, false);
                        }
                    } catch (error) {
                        setLoadingState(false);
                        showFeedback("Error de conexión al intentar borrar.", false);
                    }
                };
            }
        });
        function filterSocios() {
            const input = document.getElementById('searchInput');
            const filter = input.value.toLowerCase();
            const table = document.getElementById('sociosTable');
            const tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) { // Empezamos en 1 para saltar el encabezado
                const tdNombre = tr[i].getElementsByTagName('td')[1]; // Columna Apellido y Nombre
                const tdDni = tr[i].getElementsByTagName('td')[2];    // Columna DNI

                if (tdNombre || tdDni) {
                    const txtValueNombre = tdNombre.textContent || tdNombre.innerText;
                    const txtValueDni = tdDni.textContent || tdDni.innerText;

                    if (txtValueNombre.toLowerCase().indexOf(filter) > -1 || txtValueDni.indexOf(filter) > -1) {
                        tr[i].style.display = "";
                    } else {
                        tr[i].style.display = "none";
                    }
                }
            }
        }

    </script>
</body>

</html>